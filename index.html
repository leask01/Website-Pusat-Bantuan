<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengaduan | BMN Internal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 antialiased flex h-screen overflow-hidden">

    <aside class="w-64 bg-slate-900 text-white flex flex-col hidden md:flex no-print">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <i class="fas fa-city text-[#ffa600] mr-2"></i>
            <span class="font-bold text-lg tracking-tight">BMN Portal</span>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="flex items-center px-4 py-3 bg-[#ffa600] text-slate-900 rounded-lg font-bold">
                <i class="fas fa-clipboard-list mr-3"></i> Data Pengaduan
            </a>
            <a href="index.html" class="flex items-center px-4 py-3 text-gray-400 hover:text-white transition">
                <i class="fas fa-external-link-alt mr-3"></i> Lihat Web Form
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 no-print">
            <h1 class="text-xl font-bold text-slate-900">Dashboard Monitoring Keluhan</h1>
            <div class="relative">
                <i class="fas fa-bell text-gray-400 text-xl"></i>
                <span id="pendingCountBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full hidden">0</span>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 no-print">
                <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
                    <p class="text-sm font-semibold text-gray-400 uppercase">Pending</p>
                    <h2 id="statPending" class="text-3xl font-bold text-slate-900">0</h2>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
                    <p class="text-sm font-semibold text-gray-400 uppercase text-blue-500">Diproses</p>
                    <h2 id="statDiproses" class="text-3xl font-bold text-slate-900">0</h2>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
                    <p class="text-sm font-semibold text-gray-400 uppercase text-green-500">Selesai</p>
                    <h2 id="statSelesai" class="text-3xl font-bold text-slate-900">0</h2>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center no-print">
                    <h3 class="font-bold">Daftar Laporan Masuk</h3>
                    <button onclick="fetchComplaints()" class="text-sm text-[#ffa600] hover:underline"><i class="fas fa-sync-alt mr-1"></i> Refresh Data</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 font-semibold uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4">Tgl Masuk</th>
                                <th class="px-6 py-4">Konsumen</th>
                                <th class="px-6 py-4">Project / Unit</th>
                                <th class="px-6 py-4">Kategori</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-center no-print">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="complaintTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const supabaseUrl = 'https://wjmilsczkzoyijfrghmc.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqbWlsc2N6a3pveWlqZnJnaG1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMzIyNzQsImV4cCI6MjA4MTgwODI3NH0.-CXQ_HKRS23MX5mBwQVbaFlsOOlFjywMGPEJqWXXM2s'  
        const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

        let allComplaints = [];

        async function fetchComplaints() {
            const { data, error } = await sb.from('pengaduan_konsumen').select('*').order('created_at', { ascending: false });
            if (error) return;
            allComplaints = data;
            renderTable(data);
            updateStats(data);
        }

        function renderTable(data) {
            const tbody = document.getElementById('complaintTableBody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const date = new Date(item.created_at).toLocaleDateString('id-ID');
                let statusClass = item.status === "Diproses" ? "bg-blue-100 text-blue-600" : (item.status === "Selesai" ? "bg-green-100 text-green-600" : "bg-gray-100 text-gray-600");
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium">${date}</td>
                    <td class="px-6 py-4 font-bold">${item.nama_konsumen}<br><span class="text-xs font-normal text-gray-400">${item.no_wa}</span></td>
                    <td class="px-6 py-4">${item.project}<br><span class="font-semibold text-[#ffa600]">Blok ${item.unit}</span></td>
                    <td class="px-6 py-4 font-bold text-xs uppercase">${item.jenis_keluhan}</td>
                    <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-[11px] font-bold ${statusClass}">${item.status}</span></td>
                    <td class="px-6 py-4 text-center no-print space-x-3">
                        <button onclick="printComplaint(${item.id})" class="text-slate-400 hover:text-slate-900"><i class="fas fa-print"></i></button>
                        <button onclick="updateStatusPrompt(${item.id}, '${item.status}')" class="text-slate-400 hover:text-[#ffa600]"><i class="fas fa-edit"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats(data) {
            const pending = data.filter(d => d.status === 'Pending').length;
            document.getElementById('statPending').innerText = pending;
            document.getElementById('statDiproses').innerText = data.filter(d => d.status === 'Diproses').length;
            document.getElementById('statSelesai').innerText = data.filter(d => d.status === 'Selesai').length;
            const badge = document.getElementById('pendingCountBadge');
            badge.innerText = pending;
            pending > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
        }

        async function updateStatusPrompt(id, current) {
            const status = prompt("Ubah Status (Pending/Diproses/Selesai):", current);
            if (status) {
                await sb.from('pengaduan_konsumen').update({ status }).eq('id', id);
                fetchComplaints();
            }
        }

        function printComplaint(id) {
            const item = allComplaints.find(c => c.id === id);
            if (!item) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print - ${item.nama_konsumen}</title>
                    <style>
                        body { font-family: 'Segoe UI', sans-serif; padding: 40px; color: #333; }
                        .kop { display: flex; align-items: center; border-bottom: 3px double #000; padding-bottom: 15px; margin-bottom: 25px; }
                        .kop img { width: 80px; height: auto; margin-right: 20px; }
                        .kop-text h2 { margin: 0; font-size: 22px; color: #000; }
                        .kop-text p { margin: 2px 0; font-size: 12px; }
                        .title { text-align: center; font-size: 18px; font-weight: bold; text-decoration: underline; margin-bottom: 20px; margin-top: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
                        table td { padding: 12px; border: 1px solid #ddd; font-size: 14px; }
                        .label { width: 30%; background: #f9f9f9; font-weight: bold; }
                        
                        /* BAGIAN TANDA TANGAN BERJEJER */
                        .footer-container { 
                            margin-top: 50px; 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: flex-start;
                        }
                        .sign-box { 
                            text-align: center; 
                            width: 30%; /* Biar bagi tiga rata */
                        }
                        .sign-box p { 
                            margin-bottom: 80px; 
                            font-weight: bold; 
                            font-size: 14px; 
                        }
                        .sign-name {
                            font-weight: bold;
                            text-decoration: none;
                        }
                    </style>
                </head>
                <body>
                    <div class="kop">
                        <img src="gambar/logo_bmn.png" alt="Logo">
                        <div class="kop-text">
                            <h2>PT BUNGSU MANDIRI NAWASENA</h2>
                            <p>Pusat Pengembangan Properti & Konstruksi</p>
                            <p>Jl. Ambadar, Kec. Cibinong, Kab. Bogor, Jawa Barat</p>
                        </div>
                    </div>
                    
                    <div class="title">LAPORAN PENGADUAN KONSUMEN & SPK</div>
                    <p style="text-align:right; font-size:12px; margin-bottom: 10px;">ID Laporan: #${item.id} | Tanggal: ${new Date(item.created_at).toLocaleDateString('id-ID')}</p>

                    <table>
                        <tr><td class="label">Nama Pemilik</td><td>${item.nama_konsumen}</td></tr>
                        <tr><td class="label">No. WhatsApp</td><td>${item.no_wa}</td></tr>
                        <tr><td class="label">Project / Cluster</td><td>${item.project}</td></tr>
                        <tr><td class="label">Blok / No. Unit</td><td>${item.unit}</td></tr>
                        <tr><td class="label">Tgl. Serah Terima</td><td>${item.tgl_serah_terima}</td></tr>
                        <tr><td class="label">Kategori Keluhan</td><td><b>${item.jenis_keluhan.toUpperCase()}</b></td></tr>
                        <tr><td class="label" style="vertical-align:top">Detail Masalah</td><td height="120" style="vertical-align:top">${item.detail_keluhan}</td></tr>
                    </table>

                    <div class="footer-container">
                        <div class="sign-box">
                            <p>Pelapor / Konsumen</p>
                            <span class="sign-name">( __________________ )</span>
                        </div>
                        <div class="sign-box">
                            <p>Penerima Komplain</p>
                            <span class="sign-name">( __________________ )</span>
                        </div>
                        <div class="sign-box">
                            <p>Tim Lapangan</p>
                            <span class="sign-name">( __________________ )</span>
                        </div>
                    </div>

                    <script>
                        window.onload = function() { 
                            window.print(); 
                            // window.close(); // Opsional: hapus komentar ini jika mau tab langsung tutup setelah print
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        document.addEventListener('DOMContentLoaded', fetchComplaints);
    </script>
</body>
</html>